## 大模型调用前 Token 数判断需求

在每次调用大模型（尤其是 deep_think_llm 方法）前，需要先获取输入的 token 数。
如果原始 input 的 token 数超过模型的限制，则本次请求无法得到结果。
希望能在调用 deep_think_llm 之前提前判断和处理这种情况，而不仅仅依赖 _generate 方法返回的 input_token 长度。

### 优化方案
1. 优先使用 `len(prompt)` 判断输入字符长度，如果明显未超限，则直接使用原始输入，提升速度。
2. 只有当字符长度接近或超过最大输入字符数的 80% 时，再用本地分词器精确计算 token 数。
3. 如果 token 数超过最大输入 token 数的 80%，则只保留前 80% 的 token，并在结尾加上 '...'，以保证有足够空间用于模型输出。
4. 这样可以兼顾性能和准确性，避免无输出空间或报错。


## TradingAgents 日志与结果文件需求

### 目标
- 每次运行分析脚本（如 mainA.py）时，日志文件自动写入到如下结构：
  E:\my_agent_learning\TradingAgents\results\<股票代码>\<分析日期>\tradingagents.log
- 日志与分析结果报告文件（如 Markdown）同目录，便于溯源和管理。
- 日志内容包括分析过程、错误、决策等。

目录结构示例：
```
E:\my_agent_learning\TradingAgents\results\
    600048\
        2025-08-17\
            tradingagents.log
            report.md
        2025-08-16\
            tradingagents.log
            report.md
    300059\
        2025-08-17\
            tradingagents.log
            report.md
```

### 需求说明
1. 日志文件路径需根据当前分析股票代码和日期动态生成。
2. 日志文件名固定为 tradingagents.log，报告文件名可为 report.md。
3. 日志写入方式需兼容 logging 标准库，支持自动创建目录。
4. 结果目录可通过 config 或环境变量指定根路径。
5. mainA.py 及相关脚本需自动按上述规则写入日志。


---

## Windows定时任务与飞书文档交互需求

### 目标
- 在Windows系统上定时运行Python脚本（如每隔10分钟一次）。
- 脚本需能与飞书文档（表格）进行交互，包括读取和更新表格内容。

### 需求说明
本部分分为两个阶段：

#### 阶段一：初始化
1. 创建飞书多维表格（Bitable），并记录表格API相关信息（如表格ID、API密钥等），用于后续自动化脚本访问。
2. 表格字段建议：股票代码（手动填写）、请求日期（自动/脚本填写）、当前状态（自动/脚本填写）、回复链接（自动/脚本填写）。
3. 初始化后，表格仅需填写股票代码，其他字段可为空。

##### 获取飞书 access_token 方法
1. 可通过官方 Python SDK 或 REST API 获取 access_token，建议使用 refresh_feishu_token.py 脚本自动刷新。
2. 示例命令：
    ```powershell
    cd E:\my_agent_learning\TradingAgents\TradingAgents-CN-main
    python .\refresh_feishu_token.py
    ```
3. access_token 获取后自动写入配置文件或环境变量，供后续脚本调用。
4. 若 access_token 过期，需重新运行上述脚本刷新。

---

#### 阶段二：日常活动
1. Windows“任务计划程序”定时运行Python脚本（如每日9:00~10:00，每10分钟一次）。
2. 脚本通过飞书API读取表格，筛选“当前状态”为空的行。
3. 对每一行，提取股票代码，调用 mainA.py 执行分析流程。
4. 生成分析报告，上传至飞书文档，获取文档链接。
5. 回写飞书表格：当前状态（已完成/失败）、回复链接（文档地址），通过 record_id 定位行。
6. 错误处理：如分析失败，当前状态写“失败”，回复链接可为空或写明原因。
7. 日志记录：每次处理需写入日志，便于追踪。
8. 飞书API密钥、表格ID等参数需在.env或config中配置。

---


---


## 飞书表格自动分配ID及主流程说明

1. 飞书多维表格（Bitable）每新增一行会自动分配唯一ID（如record_id），无需手动填写。
2. 脚本通过API获取和定位该ID，用于后续读取和更新，无需用户关心。
3. 表格字段建议：股票代码（手动填写）、请求日期（自动/脚本填写）、当前状态（自动/脚本填写）、回复链接（自动/脚本填写）。
4. 主处理流程：
    - 飞书表格初始行只需填写股票代码，其他字段为空。
    - mainA.py定时读取飞书表格，筛选“当前状态”为空的行。
    - 对每一行，提取股票代码，执行分析流程。
    - 生成分析报告，上传至飞书文档，获取文档链接。
    - 回写飞书表格：填入请求日期、当前状态（已完成/失败）、回复链接（文档地址），通过ID定位行。
    - 错误处理：如分析失败，当前状态写“失败”，回复链接可为空或写明原因。
    - 日志记录：每次处理需写入日志，便于追踪。
5. 自动分配ID保证唯一性和操作安全，便于批量处理和自动化。
6. Windows任务计划程序定时运行mainA.py，每10分钟自动处理新任务。
7. 飞书API密钥、表格ID等参数需在.env或config中配置。