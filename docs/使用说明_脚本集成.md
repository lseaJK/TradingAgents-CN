# TradingAgents飞书集成脚本使用说明

## 📋 项目概述

本项目包含两个主要脚本，用于将TradingAgents股票分析系统与飞书表格进行集成：

1. **mainB.py** - 飞书API接口测试脚本
2. **mainA.py** - 完整集成脚本（包含真实TradingAgents分析）

## 🔧 环境配置

### 前置条件

1. **飞书应用配置**
   - 在 `TradingAgents-CN-main/.env` 文件中配置：
     ```
     FEISHU_APP_ID=your_app_id
     FEISHU_APP_SECRET=your_app_secret
     TABLE_APP_TOKEN=SCrXbf2WJaPLV5sqBTOcxzzknWb
     TABLE_ID=tblmJhLZBJAaAAPf
     ```

2. **飞书应用权限**
   - 确保飞书应用具有 `bitable:app:readwrite` 权限
   - 确保应用具有文档创建权限

3. **Python环境**
   - Python 3.8+
   - 安装必要依赖：
     ```bash
     pip install requests python-dotenv
     ```

## 📜 脚本详情

### mainB.py - 飞书API接口测试脚本

#### 🎯 功能
- **专注于飞书API测试**，不涉及TradingAgents
- 测试飞书访问令牌获取
- 测试表格数据读取和写入
- 测试文档创建和链接生成
- 生成测试用的分析报告

#### 🚀 使用方法
```bash
python mainB.py
```

#### 📊 输出内容
- 飞书API连接测试报告
- 表格操作测试结果
- 文档创建测试验证
- 测试用的股票分析内容（非真实分析）

#### 📁 生成文件
- `results/test_reports/` - HTML格式测试报告
- `results/test_results/` - 文本格式测试结果

### mainA.py - 完整集成脚本

#### 🎯 功能
- **完整的TradingAgents与飞书集成**
- 调用真实的TradingAgents进行股票分析
- 生成专业的投资分析报告
- 创建飞书文档并更新表格状态

#### 🚀 使用方法
```bash
python mainA.py
```

#### 📊 输出内容
- 真实的TradingAgents股票分析
- 技术面和基本面分析
- 投资建议和风险评估
- 专业的分析报告文档

#### 📁 生成文件
- `results/reports/` - HTML格式分析报告
- `results/{股票代码}/{日期}/` - 文本格式分析结果

## 🔄 工作流程

### 通用流程
1. **初始化** - 获取飞书访问令牌
2. **读取任务** - 从飞书表格获取待处理的股票
3. **处理分析** - 生成分析内容（测试/真实）
4. **创建文档** - 上传分析报告到飞书
5. **更新状态** - 更新表格中的处理状态和文档链接

### mainB.py特有流程
```
飞书API测试 → 生成测试内容 → 创建测试文档 → 更新状态为"测试完成"
```

### mainA.py特有流程
```
TradingAgents分析 → 生成真实报告 → 创建分析文档 → 更新状态为"已完成"
```

## 📋 表格字段说明

飞书表格应包含以下字段：
- **股票代码** - 待分析的股票代码（如：000001）
- **股票名称** - 股票名称（如：平安银行）
- **当前状态** - 处理状态（空/待处理/测试中/分析中/已完成等）
- **请求日期** - 请求分析的日期
- **回复链接** - 生成的分析报告链接

## 🧪 测试建议

### 第一步：使用mainB.py测试
1. 运行 `python mainB.py`
2. 检查飞书API连接是否正常
3. 验证表格读写功能
4. 确认文档创建功能

### 第二步：使用mainA.py完整测试
1. 确保TradingAgents环境配置正确
2. 运行 `python mainA.py`
3. 检查真实分析是否正常执行
4. 验证完整的集成流程

## ⚠️ 注意事项

### API限制
- 飞书API有调用频率限制，脚本已内置重试机制
- 批量处理时会自动添加延迟避免超限

### 错误处理
- 网络超时：自动重试3次
- 令牌失效：自动重新获取
- 文档创建失败：自动尝试多种方法

### 文件权限
- 确保有写入 `results/` 目录的权限
- 本地HTML文件作为文档创建的备用方案

## 🔍 调试信息

两个脚本都提供详细的日志输出：
- ✅ 成功操作
- ❌ 失败操作
- 🔄 重试操作
- ⏰ 超时信息
- 📊 状态更新

## 📞 故障排除

### 常见问题

1. **令牌获取失败**
   - 检查 FEISHU_APP_ID 和 FEISHU_APP_SECRET 配置
   - 确认网络连接正常

2. **表格读取失败**
   - 检查 TABLE_APP_TOKEN 和 TABLE_ID 是否正确
   - 确认应用有表格访问权限

3. **TradingAgents初始化失败**（仅mainA.py）
   - 检查TradingAgents环境配置
   - 确认相关依赖已安装

4. **文档创建失败**
   - 检查应用文档创建权限
   - 会自动降级使用本地HTML文件

## 📈 版本信息

- **mainB.py**: v1.0 - 飞书接口测试版
- **mainA.py**: v2.0 - 完整集成版
- **创建日期**: 2025-08-19
- **作者**: AI Assistant

## 🔄 升级路径

1. 先使用 `mainB.py` 验证飞书集成基础功能
2. 配置和测试TradingAgents环境
3. 使用 `mainA.py` 进行完整的生产级部署

---

**建议**: 在生产环境使用前，请先在测试环境中验证所有功能的正常运行。
